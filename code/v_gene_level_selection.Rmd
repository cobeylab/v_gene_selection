---
title: "V gene-level selection"
output: html_notebook
---


```{r}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggdendro)
library(cowplot)
library(scales)
library(viridis)

theme_set(theme_cowplot())

source('gene_frequency_functions.R')
 
# Load precomputed gene frequencies, neutral realizations, pairwise correlations 

load('../results/precomputed_gene_freqs.RData')
#load('~/Desktop/v_gene_selection_files/precomputed_gene_freqs.RData')

seq_counts <- bind_rows(exp_seq_counts, naive_seq_counts)


# Basic info for each clone (germline genes, CDR lenght, naive CDR seq)
clone_info <- read_csv('../processed_data/clone_info.csv')
# clone_info <- read_csv('~/Desktop/v_gene_selection_files/clone_info.csv')

```

Throughout the analyses, we exclude compartments with fewer than
```{r, echo = T}
min_seqs = 100
```


We begin by looking at the correlation between naive and experienced frequencies within each mouse. We know that most V genes are represented in lymph node populations, which are likely flu induced. This observation suggests that most V genes are capable of recombining into receptors that bind some flu antigen. Are V genes represented in the lymph node populations in frequencies similar to those in the naive repertoire? Generally yes, there's a positive correlation between naive and e    xperienced frequencies. But this correlation decreases seems to decrease over time for PCs and GC cells. (Most control mice have very few LN sequences. Those with 100 or more are represented in the figure below.) 


```{r}
# Spearman correlation coefficients
naive_exp_correlations_obs <- get_naive_exp_correlations(gene_freqs) %>%
        filter(total_compartment_seqs >= min_seqs, total_mouse_naive_seqs >= min_seqs) %>%
  mutate(group_controls_pooled = factor(group_controls_pooled, levels = group_controls_pooled_factor_levels)) %>%
  mutate(cell_type = factor(cell_type, levels = c('GC','PC','mem','nonnaive_IgD+B220+','experienced')))

naive_exp_correlations_neutral <- lapply(neutral_realizations %>% group_by(replicate) %>% group_split(),
                                         FUN = get_naive_exp_correlations)

naive_exp_correlations_neutral <- bind_rows(naive_exp_correlations_neutral, .id = 'replicate') %>%
  mutate(replicate = as.numeric(replicate)) %>%
  filter(total_compartment_seqs >= min_seqs, total_mouse_naive_seqs >= min_seqs) %>%
  mutate(group_controls_pooled = factor(group_controls_pooled, levels = group_controls_pooled_factor_levels)) %>%
  mutate(cell_type = factor(cell_type, levels = c('GC','PC','mem','nonnaive_IgD+B220+','experienced')))

naive_exp_correlations_obs %>%
        filter(tissue == 'LN', cell_type != 'experienced') %>%
        ggplot(aes(x = group_controls_pooled, y = naive_exp_corr, color = infection_status)) +
        geom_boxplot(data = naive_exp_correlations_neutral %>%
                       filter(tissue == 'LN', cell_type != 'experienced'),
                     outlier.alpha = 0) +
        geom_boxplot(outlier.alpha = 0) +
        geom_point(aes(size = total_compartment_seqs), shape = 1,
                   position = position_jitter(width = 0.1)) +
        facet_grid(.~cell_type, scales = 'free') +
        theme(axis.text.x = element_text(angle = 20, vjust = 0.5), legend.position = 'top') +
        xlab('Group') +
        ylab('Correlation in gene frequencies\nin naive repertoire vs. lymph node cells') +
        geom_hline(yintercept = 0, linetype = 2) +
        #scale_color_manual(values = c('green3','dodgerblue2')) +
        scale_size_continuous(name = 'Number of sequences',
                              breaks = c(1000,10000,20000)) +
        guides(color = 'none') +
        background_grid()

```
Here's what that correlation looks like for plasma cells on day 8 mice:

```{r}
plot_naive_freq_corr <- function(group_controls_pooled, tissue, cell_type, min_seqs){
        stopifnot(tissue == 'LN') # If looking at other tissues have to change y axis
        
        cell_type_label <- switch(cell_type,
                                  'GC' = 'germinal center cells',
                                  'PC' = 'plasma cells',
                                  'mem' = 'memory cells',
                                  'nonnaive_IgD+B220+' = 'non-naive IgD+B220+ cells')
        
        gene_freqs %>% 
                filter(group_controls_pooled == !!group_controls_pooled, tissue == !!tissue, cell_type == !!cell_type) %>%
                filter(total_compartment_seqs >= min_seqs, total_mouse_naive_seqs >= min_seqs) %>%
                ggplot(aes(x = naive_vgene_seq_freq, vgene_seq_freq)) +
                geom_point() +
                facet_wrap('mouse_id', nrow = 2) +
                scale_y_log10() +
                scale_x_log10() + 
                #geom_abline(slope = 1, intercept = 0, linetype = 2) +
                #geom_smooth(method = 'lm') +
                background_grid() +
                xlab('Frequency in naive repertoire') +
                ylab(paste0('Frequency in lymph node ', cell_type_label))
}
plot_naive_freq_corr('primary-8', 'LN','PC', min_seqs = min_seqs)
```


And for lymph node plasma cells on day 56 mice (24 days after secondary infection) 

```{r}
plot_naive_freq_corr('secondary-56', 'LN','PC', min_seqs = min_seqs)
```

To test for the apparent decline in the correlation between naive and experienced frequencies over time in infected mice, we use a linear regression between the Spearman correlation coefficient and time in days since the primary infection

```{r}
naive_exp_correlations_in_LN <- naive_exp_correlations_obs %>%
  filter(tissue == 'LN', group_controls_pooled != 'control', cell_type %in% c('GC','PC','mem')) %>%
  mutate(day = as.integer(as.character(day))) %>%
  group_by(cell_type)

test <- lm(naive_exp_corr ~ cell_type + cell_type*day, data = naive_exp_correlations_in_LN)
summary(test)

naive_exp_correlations_in_LN %>%
  ggplot(aes(x = day, y = naive_exp_corr)) +
  facet_wrap('cell_type') +
  geom_smooth(method = 'lm') +
  geom_point()

```


** MAKING SENSE OF STUFF **

The data:
```{r}
naive_exp_correlations_obs %>%
        filter(tissue == 'LN', cell_type %in% c('GC','PC','mem'),
               group_controls_pooled != 'control') %>%
        ggplot(aes(x = group_controls_pooled, y = naive_exp_corr, color = infection_status)) +
        geom_boxplot(outlier.alpha = 0) +
        geom_point(aes(size = total_compartment_seqs), 
                   position = position_jitter(width = 0.1)) +
        facet_grid(.~cell_type, scales = 'free') +
        theme(axis.text.x = element_text(angle = 20, vjust = 0.5), legend.position = 'top') +
        xlab('Group') +
        ylab('Correlation in gene frequencies\nin naive repertoire vs. lymph node cells') +
        geom_hline(yintercept = 0, linetype = 2) +
        scale_color_manual(values = c('green3','dodgerblue2')) +
        scale_size_continuous(name = 'Number of sequences',
                              breaks = c(1000,10000,20000)) +
        guides(color = 'none') +
        background_grid()
```

Separate linear regressions show the correlation decreases with time for GC cells and PCs but not memory cells

```{r}

summary(lm(naive_exp_corr ~ day,
   data = naive_exp_correlations_in_LN %>% filter(cell_type == 'GC')))

summary(lm(naive_exp_corr ~ day,
   data = naive_exp_correlations_in_LN %>% filter(cell_type == 'PC')))

summary(lm(naive_exp_corr ~ day,
   data = naive_exp_correlations_in_LN %>% filter(cell_type == 'mem')))



```

But then a single linear model with cell type plus an interaction of day and cell type gives very strange
results. Using GC as the reference group in the linear model, the correlation decreases with time for GCs but not PCs and increases with time for memory cells

```{r}
summary(lm(naive_exp_corr ~ cell_type + cell_type*day -1,
           data = naive_exp_correlations_in_LN %>%
             filter(infection_status == 'primary')))
```

However, if I relevel and make memory the reference group, the correlation does not decrease for memory but decreases for GC cells and plasma cells (i.e., we get a result that agrees with our visual impression.)


```{r}
summary(lm(naive_exp_corr ~ cell_type + cell_type*day,
           data = naive_exp_correlations_in_LN %>%
             mutate(cell_type = relevel(cell_type, ref = 'mem'))))
```


```{r}
summary(lm(naive_exp_corr ~ group_controls_pooled*cell_type,
           data = naive_exp_correlations_in_LN ))
```

