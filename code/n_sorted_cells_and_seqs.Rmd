---
title: "Cell sorting data reveals flu-induced B cell populations in the lymph node"
output: html_document
---

```{r setup, include=FALSE, echo = F, warnings = F}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(readr)
library(tidyr)
library(ggplot2)
library(cowplot)
library(stringr)
source('gene_frequency_functions.R')
theme_set(theme_cowplot())
n_sorted_cells <- read_csv('../data/n_sorted_cells.csv') %>%
  mutate(cell_type = as.character(cell_type))

n_sorted_cells$cell_type[n_sorted_cells$cell_type == 'naive'] <- 'IgD+B220+'

processed_data_dir <- '../processed_data/'
#processed_data_dir <- '~/Desktop/v_gene_selection/processed_data/'


seq_counts <- read_csv(paste0(processed_data_dir, 'seq_counts.csv'))
unique_seq_counts <- read_csv(paste0(processed_data_dir, 'unique_seq_counts.csv'))

seq_counts <- bind_rows(seq_counts %>% mutate(seq_type = 'all productive sequences'),
                        unique_seq_counts %>% mutate(seq_type = 'unique productive sequences') %>%
                          dplyr::rename(n_seqs = unique_prod_seqs)) %>%
  select(seq_type, everything())


seq_counts <- get_info_from_mouse_id(seq_counts)

# Aggregated sequence numbers across clones, to look at n seqs per mouse / tissue / cell type
seq_counts <- seq_counts %>%
  group_by(seq_type, mouse_id, day, infection_status, group, group_controls_pooled, tissue, cell_type) %>%
  summarise(n_seqs = sum(n_seqs)) %>%
  mutate(group_controls_pooled = factor(group_controls_pooled, levels = group_controls_pooled_factor_levels)) %>%
  mutate(tissue = factor(tissue, levels = c('LN','spleen','BM'))) %>%
  mutate(cell_type = factor(cell_type, levels = c('naive','nonnaive_IgD+B220+', 'GC','PC','mem')))
```



In the mediastinal lymph node, plasma cells, germinal center cells and to a lesser extent memory cells are scarce in controls but abundant in infected mice, suggesting those cells were induced by flu:

```{r echo = F, warning = F, fig.width=12, fig.height=6}
n_sorted_cells <- get_info_from_mouse_id(n_sorted_cells) %>%
  mutate(mouse_id = factor(mouse_id, levels = mouse_id_factor_levels),
         group = factor(group, levels = group_factor_levels),
         group_controls_pooled = factor(group_controls_pooled,
                                        levels = group_controls_pooled_factor_levels)) %>%
  mutate(cell_type = case_when(
           cell_type == 'IgD+B220+' ~ 'IgD+B220+ (putatively naive) cells',
           cell_type == 'GC' ~ 'Germinal center cells',
           cell_type == 'PC' ~ 'Plasma cells',
           cell_type == 'mem' ~ 'Memory cells'),
         tissue = case_when(
           tissue == 'LN' ~ 'Mediastinal LN',
           tissue == 'spleen' ~ 'Spleen',
           tissue == 'BM' ~ 'Bone marrow'
         )
    ) %>%
  mutate(cell_type = factor(cell_type, levels = c('IgD+B220+ (putatively naive) cells',
                                                  'Germinal center cells','Plasma cells',
                                                  'Memory cells')),
         tissue = factor(tissue, levels = c('Mediastinal LN',
                                            'Spleen','Bone marrow')))

n_sorted_cells_plot <- n_sorted_cells %>% 
  ggplot(aes(x = group_controls_pooled, y = sorted_cells, color = infection_status)) +
  facet_grid(tissue~cell_type, scales = 'free') +
  geom_boxplot(outlier.alpha = 0) +
  geom_point(position = position_jitter(width = 0.1)) +
  #geom_text(aes(label = mouse_id), position = position_jitter(width = 0.1)) +
  scale_y_log10(breaks = c(10,100,1000,10000,100000,1000000),
                labels = c(10,100,1000,10000,100000,1000000)) +
  background_grid() +
  xlab('Group') +
  ylab('Number of cells sorted') +
  theme(legend.position = 'top',
        axis.text.x = element_text(size = 8, angle = 40,
                                     vjust = 0.5)) +
  scale_color_discrete(name = 'Infection')
plot(n_sorted_cells_plot)
# Export 
save(n_sorted_cells_plot,
     file = '../figures/all_seqs_freqs/exported_ggplot_objects/n_cells_sorted.RData')
```


Consistent with the finding above, few productive sequences from plasma, germinal center and memory cells were recovered from the lymph nodes of controls compared with infected mice:

```{r echo =F, warning=F, fig.width=12, fig.height=6}
# base_plotting_function <- function(seq_counts_tibble, seq_type){
#   if(seq_type == 'all productive sequences'){
#     ylabel = 'Number of productive sequences'
#   }else{
#     stopifnot(seq_type == 'unique productive sequences')
#     ylabel = 'Number of unique productive sequences'
#   }
#   seq_counts_tibble %>%
#     filter(seq_type == !!seq_type) %>%
#     ggplot(aes(x = group_controls_pooled, y = n_seqs, color = infection_status)) +
#     geom_boxplot(outlier.alpha = 0) +
#     geom_point() +
#     facet_grid(tissue~cell_type, scales = 'free') +
#     theme(legend.position = 'top',
#           axis.text.x = element_text(size = 8, angle = 40,
#                                      vjust = 0.5)) +
#     #scale_x_discrete(labels = function(x){str_replace(x, '-','\n')}) +
#     background_grid() +
#     xlab('Group') +
#     ylab(ylabel) +
#     scale_color_discrete(name = 'Infection status') +
#     scale_y_log10()
#     
# }
# 
# base_plotting_function(seq_counts_tibble = seq_counts,
#                        seq_type = 'all productive sequences')
# 
# base_plotting_function(seq_counts_tibble = seq_counts,
#                        seq_type = 'unique productive sequences')

```
```{r echo =F, warning=F, fig.width=12, fig.height=8}
# Add sequence counts for all IgD+B220+ sequences to compare with cell sorting data
# seq_counts <- bind_rows(seq_counts,
#                         seq_counts %>% filter(cell_type %in% c('naive','nonnaive_IgD+B220+')) %>%
#                           group_by(seq_type, mouse_id, day, infection_status, group, group_controls_pooled, tissue) %>%
#                           summarise(n_seqs = sum(n_seqs)) %>%
#                           ungroup() %>%
#                           mutate(cell_type = 'IgD+B220+')) 
# 
# seqs_per_sorted_cell <- left_join(seq_counts, n_sorted_cells) %>%
#   filter((cell_type %in% c('naive','nonnaive_IgD+B220+')) == F) %>%
#   mutate(cell_type = factor(cell_type, levels = c('IgD+B220+','GC','PC','mem'))) %>%
#   mutate(seqs_per_cell = n_seqs/sorted_cells)
# 
# 
# seqs_per_sorted_cell %>% 
#   filter(seq_type == 'all productive sequences') %>%
#   ggplot(aes(x = group_controls_pooled, y = seqs_per_cell, color = infection_status)) +
#     geom_boxplot(outlier.alpha = 0) +
#     geom_point() +
#     facet_grid(tissue~cell_type, scales = 'free') +
#     theme(legend.position = 'top',
#           axis.text.x = element_text(size = 8, angle = 40,
#                                      vjust = 0.5)) +
#     #scale_x_discrete(labels = function(x){str_replace(x, '-','\n')}) +
#     background_grid() +
#     xlab('Group') +
#     ylab('Number of productive sequences per sorted cell') +
#     scale_color_discrete(name = 'Infection status') +
#     scale_y_log10(breaks = c(0.001,0.01,0.1,1,10,100),
#                   labels = c(0.001,0.01,0.1,1,10,100)) +
#   geom_hline(yintercept = 1, linetype = 2)
#   
```


